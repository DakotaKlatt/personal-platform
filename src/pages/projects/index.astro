---
import PageLayout from '../../layouts/PageLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { getAllProjectsSorted, projectTags } from '../../data/projects';

const sorted = getAllProjectsSorted();
---

<PageLayout
  title="Projects — Dakota Klatt"
  description="Projects and side builds: OpenCut Studio and more. Optional learning roadmap for potential future ideas."
>
  <div class="mx-auto max-w-5xl px-6 py-section">
    <header class="mb-block">
      <h1 id="main-content" class="font-display font-semibold text-display-xl text-[var(--color-text)] mb-4">
        Projects
      </h1>
      <p class="text-[var(--color-text-muted)] max-w-2xl mb-2">
        Shipped projects and side builds. Filter by focus area below.
      </p>
      <p class="text-[var(--color-text-muted)] max-w-2xl text-sm">
        Optional: potential future project ideas are hidden by default—use the button below to show them.
      </p>
    </header>

    <div class="flex flex-wrap gap-2 mb-8" role="group" aria-label="Filter by tag">
      <a
        href="/projects"
        data-filter="all"
        class="project-filter rounded-lg px-4 py-2 text-sm font-medium transition-colors border"
      >
        All
      </a>
      {projectTags.map((tag) => (
        <a
          href={`/projects?tag=${encodeURIComponent(tag)}`}
          data-filter={tag}
          class="project-filter rounded-lg px-4 py-2 text-sm font-medium transition-colors border"
        >
          {tag}
        </a>
      ))}
    </div>

    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="projects-grid">
      {sorted.map((project) => (
        <div
          class="project-card-item"
          data-tags={project.tags.join(',')}
          data-is-idea={project.status === 'idea' ? 'true' : 'false'}
        >
          <ProjectCard project={project} showHighlights={false} />
        </div>
      ))}
    </div>

    <p id="projects-empty" class="hidden text-[var(--color-text-muted)]">No projects match this filter.</p>

    <div class="mt-10 pt-8 border-t border-[var(--color-border)]">
      <button
        type="button"
        id="toggle-idea-projects"
        class="text-sm font-medium text-accent hover:underline"
      >
        Show potential future project ideas
      </button>
      <p id="idea-projects-hint" class="hidden mt-2 text-xs text-[var(--color-text-muted)]">
        (Click again to hide)
      </p>
    </div>

    <p class="mt-6 text-[var(--color-text-muted)] text-sm max-w-2xl">
      If you’re interested in talking through these projects, platform engineering, or what I’m building next—reach out via <a href="https://linkedin.com/in/dakota-klatt27" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline">LinkedIn</a> or <a href="mailto:DakotaKlatt27@gmail.com" class="text-accent hover:underline">email</a>. I’m open to interesting conversations.
    </p>
  </div>

  <style>
    .project-filter {
      background: var(--color-surface-elevated);
      color: var(--color-text-muted);
      border-color: var(--color-border);
    }
    .project-filter:hover {
      color: var(--color-text);
    }
    .project-filter.filter-active {
      background: var(--color-accent);
      color: white;
      border-color: rgba(13, 148, 136, 0.4);
    }
    .project-card-item[data-is-idea="true"].idea-hidden {
      display: none !important;
    }
  </style>

  <script>
    let showIdeas = false;

    function getTagFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('tag');
    }

    function applyFilter(selectedTag) {
      const grid = document.getElementById('projects-grid');
      const emptyEl = document.getElementById('projects-empty');
      const cards = grid?.querySelectorAll('.project-card-item') ?? [];
      const filters = document.querySelectorAll('.project-filter');

      let visibleCount = 0;
      cards.forEach((el) => {
        const isIdea = el.getAttribute('data-is-idea') === 'true';
        const tagMatch = !selectedTag || (el.getAttribute('data-tags') ?? '').split(',').includes(selectedTag);
        const show = tagMatch && (showIdeas || !isIdea);
        el.hidden = !show;
        el.classList.toggle('idea-hidden', isIdea && !showIdeas);
        if (show) visibleCount++;
      });

      if (emptyEl) emptyEl.classList.toggle('hidden', visibleCount > 0);

      filters.forEach((a) => {
        const filterTag = a.getAttribute('data-filter');
        const isActive = (filterTag === 'all' && !selectedTag) || filterTag === selectedTag;
        a.classList.toggle('filter-active', isActive);
      });
    }

    function updateToggleButton() {
      const btn = document.getElementById('toggle-idea-projects');
      const hint = document.getElementById('idea-projects-hint');
      if (btn) btn.textContent = showIdeas ? 'Hide potential future project ideas' : 'Show potential future project ideas';
      if (hint) hint.classList.toggle('hidden', !showIdeas);
    }

    function initFilters() {
      applyFilter(getTagFromUrl());
      updateToggleButton();

      document.querySelectorAll('.project-filter').forEach((a) => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const tag = a.getAttribute('data-filter');
          const url = new URL(window.location.href);
          if (tag && tag !== 'all') {
            url.searchParams.set('tag', tag);
          } else {
            url.search = '';
          }
          window.history.pushState({}, '', url.toString());
          applyFilter(tag === 'all' ? null : tag);
        });
      });

      document.getElementById('toggle-idea-projects')?.addEventListener('click', () => {
        showIdeas = !showIdeas;
        applyFilter(getTagFromUrl());
        updateToggleButton();
      });

      window.addEventListener('popstate', () => applyFilter(getTagFromUrl()));
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFilters);
    } else {
      initFilters();
    }
  </script>
</PageLayout>
